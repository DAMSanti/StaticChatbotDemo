<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chatbot - Static Demo</title>
  <style>
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:0;background:#f7fafc;color:#0f172a}
    .container{max-width:720px;margin:48px auto;padding:24px;background:#fff;border-radius:8px;box-shadow:0 6px 18px rgba(2,6,23,0.06)}
    .messages{height:400px;overflow:auto;border:1px solid #e6eef6;padding:12px;border-radius:6px;background:#f8fafc}
    .msg{margin:8px 0;padding:8px 12px;border-radius:16px;display:inline-block;max-width:80%}
    .msg.user{background:#0369a1;color:#fff;margin-left:auto}
    .msg.bot{background:#eef2ff;color:#0f172a}
    .input-row{display:flex;gap:8px;margin-top:12px}
    input[type="text"]{flex:1;padding:10px;border:1px solid #cbd5e1;border-radius:8px}
    button{padding:10px 14px;border:none;background:#0284c7;color:#fff;border-radius:8px}
    footer{margin-top:12px;font-size:12px;color:#475569}
  </style>
</head>
<body>
  <div class="container">
    <h1>Chatbot - Integrado</h1>
    <!-- Contenedor donde se renderizará el iframe del chatbot -->
    <div id="chat-container" style="width:100%;height:640px;border:1px solid #e6eef6;border-radius:6px;overflow:hidden;margin-top:16px"></div>

  </div>
  <!-- Chatbot widget (AbogadoVirtual Chatbot) -->
  <script async
    src="https://qyu5z3uycrlt22lufgs5ac6v.agents.do-ai.run/static/chatbot/widget.js"
    data-agent-id="a141afdb-c01e-11f0-b074-4e013e2ddde4"
    data-chatbot-id="IurFFh0JbzeH7PLauKvv7WKGaCJb5F6L"
    data-name="AbogadoVirtual Chatbot"
    data-primary-color="#031B4E"
    data-secondary-color="#E5E8ED"
    data-button-background-color="#0061EB"
    data-starting-message="Hello! How can I help you today?"
    data-logo="/static/chatbot/icons/default-agent.svg"
    data-render-target-id="chat-container">
  </script>

  <!-- Script: Convertir [C1][C2] en enlaces clickeables -->
  <script>
    (function() {
      'use strict';

      // Datos de retrieval con URLs (obtenidos del agente)
      const citationData = {
        'C1': 'https://www.boe.es/buscar/pdf/2015/BOE-A-2015-10565-consolidado.pdf',
        'C2': 'https://www.boe.es/buscar/pdf/2010/BOE-A-2010-10544-consolidado.pdf',
        'C3': 'https://www.boe.es/buscar/pdf/2010/BOE-A-2010-10544-consolidado.pdf',
        'C4': 'https://www.boe.es/buscar/pdf/2015/BOE-A-2015-10565-consolidado.pdf',
        'C5': 'https://www.boe.es/buscar/pdf/2011/BOE-A-2011-15936-consolidado.pdf',
        'C6': 'https://www.boe.es/buscar/pdf/1995/BOE-A-1995-25444-consolidado.pdf',
        'C7': 'https://www.boe.es/buscar/pdf/1998/BOE-A-1998-16718-consolidado.pdf',
        'C8': 'https://www.boe.es/buscar/pdf/2015/BOE-A-2015-11430-consolidado.pdf',
        'C9': 'https://www.boe.es/buscar/pdf/2015/BOE-A-2015-10565-consolidado.pdf',
        'C10': 'https://www.boe.es/buscar/pdf/2000/BOE-A-2000-641-consolidado.pdf',
        'C11': 'https://www.boe.es/buscar/pdf/2010/BOE-A-2010-10544-consolidado.pdf',
        'C12': 'https://www.boe.es/buscar/pdf/2010/BOE-A-2010-10544-consolidado.pdf',
        'C13': 'https://www.boe.es/buscar/pdf/1882/BOE-A-1882-6036-consolidado.pdf',
        'C14': 'https://www.boe.es/buscar/pdf/2010/BOE-A-2010-10544-consolidado.pdf',
        'C15': 'https://www.boe.es/buscar/pdf/1995/BOE-A-1995-25444-consolidado.pdf',
        'C16': 'https://www.boe.es/buscar/pdf/2015/BOE-A-2015-11724-consolidado.pdf',
        'C17': 'https://www.boe.es/buscar/pdf/2015/BOE-A-2015-11430-consolidado.pdf',
        'C18': 'https://www.boe.es/buscar/pdf/2015/BOE-A-2015-11430-consolidado.pdf'
      };

      // Observar cambios en el DOM para detectar nuevos mensajes
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.addedNodes.length) {
            mutation.addedNodes.forEach(function(node) {
              if (node.nodeType === Node.ELEMENT_NODE) {
                // Buscar y convertir citations en el nodo
                convert_citations(node);
              }
            });
          }
        });
      });

      // Iniciar observación cuando el documento esté listo
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init_observer);
      } else {
        init_observer();
      }

      function init_observer() {
        console.log('[Citation Linker] Iniciado - Observando cambios en el DOM');
        
        // Observar el contenedor del chatbot
        const chatContainer = document.getElementById('chat-container') || 
                            document.querySelector('[data-render-target-id="chat-container"]');
        
        if (chatContainer) {
          observer.observe(chatContainer, {
            childList: true,
            subtree: true,
            characterData: true
          });
          console.log('[Citation Linker] Observador conectado');
        } else {
          // Si no está disponible aún, buscar el iframe del widget
          setTimeout(() => {
            const iframes = document.querySelectorAll('iframe');
            if (iframes.length > 0) {
              observer.observe(document.body, {
                childList: true,
                subtree: true,
                characterData: true
              });
              console.log('[Citation Linker] Observando body para iframes');
            }
          }, 1000);
        }
      }

      function convert_citations(node) {
        // Buscar todos los elementos de texto que contengan [C1], [C2], etc.
        const walker = document.createTreeWalker(
          node,
          NodeFilter.SHOW_TEXT,
          null,
          false
        );

        const nodesToReplace = [];
        let currentNode;

        while (currentNode = walker.nextNode()) {
          if (currentNode.nodeValue.match(/\[C\d+\]/g)) {
            nodesToReplace.push(currentNode);
          }
        }

        // Reemplazar cada nodo con citations convertidas
        nodesToReplace.forEach(textNode => {
          const text = textNode.nodeValue;
          const regex = /\[C(\d+)\]/g;
          
          if (text.match(regex)) {
            const parent = textNode.parentNode;
            const span = document.createElement('span');
            
            let lastIndex = 0;
            let match;

            while ((match = regex.exec(text)) !== null) {
              // Agregar texto antes de la citation
              if (match.index > lastIndex) {
                span.appendChild(
                  document.createTextNode(text.substring(lastIndex, match.index))
                );
              }

              // Crear el link de la citation
              const citationNum = 'C' + match[1];
              const link = document.createElement('a');
              link.href = citationData[citationNum] || '#';
              link.className = 'citation-link';
              link.textContent = `[${citationNum}]`;
              link.title = `Click para ver la fuente de ${citationNum}`;
              link.target = '_blank';
              link.rel = 'noopener noreferrer';
              
              // Evento para mostrar tooltips
              link.addEventListener('click', function(e) {
                e.preventDefault();
                show_citation_tooltip(citationNum, link);
                // Abrir en nueva ventana después de 300ms
                setTimeout(() => {
                  window.open(citationData[citationNum], '_blank');
                }, 300);
              });

              span.appendChild(link);
              lastIndex = regex.lastIndex;
            }

            // Agregar texto restante
            if (lastIndex < text.length) {
              span.appendChild(
                document.createTextNode(text.substring(lastIndex))
              );
            }

            parent.replaceChild(span, textNode);
            console.log('[Citation Linker] Citations convertidas en:', parent.className || parent.tagName);
          }
        });
      }

      function show_citation_tooltip(citationNum, element) {
        // Crear tooltip
        const tooltip = document.createElement('div');
        tooltip.className = 'citation-tooltip';
        tooltip.textContent = citationNum + ': Ver fuente...';
        
        document.body.appendChild(tooltip);

        // Posicionar el tooltip
        const rect = element.getBoundingClientRect();
        tooltip.style.left = rect.left + 'px';
        tooltip.style.top = (rect.top - 30) + 'px';

        // Remover después de 2 segundos
        setTimeout(() => {
          tooltip.remove();
        }, 2000);
      }

      // Inyectar estilos
      const style = document.createElement('style');
      style.textContent = `
        /* Links de citations */
        .citation-link {
          color: #0284c7;
          text-decoration: none;
          font-weight: 700;
          background: linear-gradient(120deg, #e0eaff 0%, #f0f4ff 100%);
          padding: 2px 6px;
          border-radius: 4px;
          cursor: pointer;
          transition: all 0.2s ease;
          display: inline-block;
          border: 1px solid #cbd5e1;
        }

        .citation-link:hover {
          background: linear-gradient(120deg, #0284c7 0%, #0369a1 100%);
          color: white;
          border-color: #0369a1;
          transform: scale(1.1);
          box-shadow: 0 4px 8px rgba(2, 132, 199, 0.3);
        }

        .citation-link:active {
          transform: scale(0.95);
        }

        /* Tooltip de citation */
        .citation-tooltip {
          position: fixed;
          background: #0284c7;
          color: white;
          padding: 8px 12px;
          border-radius: 6px;
          font-size: 12px;
          font-weight: 600;
          z-index: 10000;
          pointer-events: none;
          box-shadow: 0 4px 12px rgba(2, 132, 199, 0.4);
          animation: tooltip-pop 0.2s ease;
          white-space: nowrap;
        }

        @keyframes tooltip-pop {
          0% {
            opacity: 0;
            transform: scale(0.8) translateY(10px);
          }
          100% {
            opacity: 1;
            transform: scale(1) translateY(0);
          }
        }

        /* Para textos en iframes */
        iframe + .citation-link {
          margin: 0 2px;
        }
      `;
      document.head.appendChild(style);

      console.log('[Citation Linker] Estilos inyectados');
    })();
  </script>
</body>
</html>
