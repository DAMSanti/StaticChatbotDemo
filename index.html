<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Abogado Virtual - Chat</title>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .chatbot-container {
      width: 100%;
      max-width: 600px;
      height: 90vh;
      max-height: 800px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .chat-header {
      background: linear-gradient(135deg, #031B4E 0%, #0061EB 100%);
      color: white;
      padding: 20px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .chat-header h1 {
      margin: 0;
      font-size: 24px;
      font-weight: 600;
    }

    .chat-header p {
      margin: 5px 0 0 0;
      font-size: 13px;
      opacity: 0.9;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: #f8f9fa;
    }

    .message-group {
      margin-bottom: 16px;
      display: flex;
      animation: fadeIn 0.3s ease-in-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message-group.user {
      justify-content: flex-end;
    }

    .message-group.bot {
      justify-content: flex-start;
    }

    .message {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 12px;
      word-wrap: break-word;
      line-height: 1.4;
    }

    .message.user {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-bottom-right-radius: 4px;
    }

    .message.bot {
      background: #e8ecf1;
      color: #1a202c;
      border-bottom-left-radius: 4px;
    }

    .message-loading {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .message-loading span {
      height: 8px;
      width: 8px;
      border-radius: 50%;
      background: #667eea;
      animation: bounce 1.4s infinite;
    }

    .message-loading span:nth-child(1) {
      animation-delay: -0.32s;
    }

    .message-loading span:nth-child(2) {
      animation-delay: -0.16s;
    }

    @keyframes bounce {
      0%, 80%, 100% {
        transform: scale(0);
        opacity: 0.5;
      }
      40% {
        transform: scale(1);
        opacity: 1;
      }
    }

    .citation-link {
      color: #0284c7;
      text-decoration: none;
      font-weight: 600;
      background: linear-gradient(120deg, #e0eaff 0%, #f0f4ff 100%);
      padding: 2px 6px;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-block;
      border: 1px solid #cbd5e1;
      margin: 0 2px;
    }

    .message.bot .citation-link {
      color: #0284c7;
    }

    .message.user .citation-link {
      color: white;
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.3);
    }

    .citation-link:hover {
      background: linear-gradient(120deg, #0284c7 0%, #0369a1 100%);
      color: white;
      border-color: #0369a1;
      transform: scale(1.05);
      box-shadow: 0 4px 8px rgba(2, 132, 199, 0.3);
    }

    .citation-link:active {
      transform: scale(0.95);
    }

    /* Formateo de respuestas del bot */
    .message.bot .disclaimer {
      background: linear-gradient(120deg, #fee2e2 0%, #fecaca 100%);
      border-left: 4px solid #dc2626;
      padding: 12px 14px;
      border-radius: 6px;
      margin-bottom: 12px;
      font-size: 13px;
      font-weight: 600;
      color: #991b1b;
    }

    .message.bot .content {
      line-height: 1.6;
      margin-bottom: 16px;
      color: #1a202c;
    }

    .message.bot .content p {
      margin: 12px 0;
    }

    .message.bot .recommendation {
      margin-bottom: 12px;
      font-size: 14px;
      color: #1a202c;
    }

    .message.bot .metadata {
      margin-top: 12px;
      font-size: 13px;
      color: #475569;
      line-height: 1.5;
    }

    .message.bot .metadata strong {
      color: #1a202c;
      font-weight: 600;
    }

    .chat-input-area {
      padding: 16px;
      background: white;
      border-top: 1px solid #e6eef6;
      display: flex;
      gap: 8px;
    }

    .chat-input-area input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      transition: all 0.2s ease;
    }

    .chat-input-area input:focus {
      outline: none;
      border-color: #0284c7;
      box-shadow: 0 0 0 3px rgba(2, 132, 199, 0.1);
    }

    .chat-input-area input::placeholder {
      color: #94a3b8;
    }

    .chat-input-area button {
      padding: 12px 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .chat-input-area button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .chat-input-area button:active {
      transform: translateY(0);
    }

    .chat-input-area button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .error-message {
      background: #fee2e2;
      color: #991b1b;
      padding: 12px 16px;
      border-radius: 8px;
      border-left: 4px solid #dc2626;
      margin-bottom: 16px;
    }

    @media (max-width: 600px) {
      .chatbot-container {
        max-height: 100vh;
        border-radius: 0;
        height: 100vh;
      }

      .message {
        max-width: 85%;
      }

      .chat-header h1 {
        font-size: 20px;
      }
    }

    /* Modal de citaciones */
    .citation-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }

    .citation-modal.active {
      display: flex;
    }

    .citation-modal-content {
      background: white;
      border-radius: 12px;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      padding: 24px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      position: relative;
    }

    .citation-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      border-bottom: 2px solid #e6eef6;
      padding-bottom: 12px;
    }

    .citation-modal-title {
      font-size: 18px;
      font-weight: 600;
      color: #031B4E;
    }

    .citation-modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #94a3b8;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .citation-modal-close:hover {
      color: #1a202c;
    }

    .citation-modal-body {
      font-size: 14px;
      line-height: 1.6;
      color: #475569;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .citation-modal-meta {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #e6eef6;
      font-size: 12px;
      color: #94a3b8;
    }

    .citation-modal-meta p {
      margin: 4px 0;
    }
  </style>
</head>
<body>
  <div class="chatbot-container">
    <div class="chat-header">
      <h1>⚖️ Abogado Virtual</h1>
      <p>Asistente de consultas legales basado en legislación española</p>
    </div>

    <div class="chat-messages" id="messages"></div>

    <div class="chat-input-area">
      <input 
        type="text" 
        id="messageInput" 
        placeholder="Escribe tu pregunta legal..."
        autocomplete="off"
      />
      <button id="sendButton" onclick="sendMessage()">Enviar</button>
    </div>
  </div>

  <!-- Modal de citaciones -->
  <div id="citationModal" class="citation-modal">
    <div class="citation-modal-content">
      <div class="citation-modal-header">
        <div class="citation-modal-title" id="citationModalTitle">Extracto de Fuente</div>
        <button class="citation-modal-close" onclick="closeCitationModal()">✕</button>
      </div>
      <div class="citation-modal-body" id="citationModalBody"></div>
      <div class="citation-modal-meta" id="citationModalMeta"></div>
    </div>
  </div>

  <script>
    'use strict';

    // Configuración
    const API_URL = 'https://qyu5z3uycrlt22lufgs5ac6v.agents.do-ai.run/api/v1/chat/completions';
    const AGENT_ID = 'a141afdb-c01e-11f0-b074-4e013e2ddde4';
    const ACCESS_TOKEN = 'XUud8PiXyP3rlDiEtGEwJylKwIKdWwpt';

    let conversationHistory = [];

    // Mapeo de citaciones a URLs (se actualizará dinámicamente)
    let citationMap = {};

    // Almacenar retrieved data para mostrar extractos
    let retrievalData = [];

    // Elementos del DOM
    const messagesContainer = document.getElementById('messages');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');

    // Enviar mensaje al presionar Enter
    messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    async function sendMessage() {
      const message = messageInput.value.trim();

      if (!message) return;

      // Deshabilitar input
      messageInput.disabled = true;
      sendButton.disabled = true;

      // Agregar mensaje del usuario
      addMessage(message, 'user');
      messageInput.value = '';

      // Agregar historial
      conversationHistory.push({
        role: 'user',
        content: message
      });

      // Mostrar indicador de escritura
      const loadingId = addLoadingIndicator();

      try {
        // Llamar a la API
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${ACCESS_TOKEN}`,
            'X-Agent-ID': AGENT_ID
          },
          body: JSON.stringify({
            messages: conversationHistory
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();

        // DEBUG: Log completo de la respuesta
        console.log('=== RESPUESTA COMPLETA DE API ===');
        console.log(JSON.stringify(data, null, 2));
        console.log('=== FIN RESPUESTA ===');
        
        // DEBUG: Verificar estructura de citaciones
        console.log('Estructura de datos:', {
          hasChoices: !!data.choices,
          hasCitations: !!data.citations,
          citationsStructure: data.citations ? Object.keys(data.citations) : null,
          hasRetrieval: !!data.retrieval,
          hasContext: !!data.context
        });

        // Remover indicador de carga
        removeLoadingIndicator(loadingId);

        // Procesar respuesta
        if (data.choices && data.choices[0]) {
          const assistantMessage = data.choices[0].message.content;
          console.log('Mensaje:', assistantMessage);

          // Extraer citaciones del mensaje (formato: [C1], 【C1】, §C1, o (§C1))
          const citationMatches = assistantMessage.match(/[\[\【]?§?C(\d+)[\]\】]?/g) || [];
          console.log('Citaciones encontradas en mensaje:', citationMatches);

          // Si hay citaciones pero no hay retrieval_data, usar URLs por defecto del BOE
          if (citationMatches.length > 0) {
            const defaultBOEUrls = [
              'https://www.boe.es/buscar/pdf/2015/BOE-A-2015-10565-consolidado.pdf',
              'https://www.boe.es/buscar/pdf/2010/BOE-A-2010-10544-consolidado.pdf',
              'https://www.boe.es/buscar/pdf/2011/BOE-A-2011-15936-consolidado.pdf',
              'https://www.boe.es/buscar/pdf/1995/BOE-A-1995-25444-consolidado.pdf',
              'https://www.boe.es/buscar/pdf/1998/BOE-A-1998-16718-consolidado.pdf',
              'https://www.boe.es/buscar/pdf/2015/BOE-A-2015-11430-consolidado.pdf',
              'https://www.boe.es/buscar/pdf/2000/BOE-A-2000-641-consolidado.pdf',
              'https://www.boe.es/buscar/pdf/1882/BOE-A-1882-6036-consolidado.pdf',
              'https://www.boe.es/buscar/pdf/2015/BOE-A-2015-11724-consolidado.pdf'
            ];

            citationMatches.forEach((match, index) => {
              const num = match.match(/\d+/)[0];
              const citationKey = `C${num}`;
              // Usar URLs por defecto (rotar si hay más citaciones que URLs)
              const urlIndex = (index % defaultBOEUrls.length);
              citationMap[citationKey] = defaultBOEUrls[urlIndex];
              console.log(`Mapeado ${citationKey} (${match}) → ${defaultBOEUrls[urlIndex]}`);
            });
          }

          // Extraer citaciones del objeto data.citations.citations
          if (data.citations && data.citations.citations) {
            console.log('✓ Citaciones encontradas en data.citations.citations');
            retrievalData = data.citations.citations;
            console.log('Citaciones almacenadas:', retrievalData);
            
            // Crear mapeo de citaciones encontradas en el mensaje a sus índices en el array
            const citationIndices = {};
            citationMatches.forEach((citationText, arrayIndex) => {
              const num = citationText.match(/\d+/)[0];
              const citationKey = `C${num}`;
              // Mapear la citación al índice en el array (secuencial)
              if (!citationIndices[citationKey]) {
                citationIndices[citationKey] = arrayIndex;
              }
            });
            console.log('Mapeo de citaciones a índices:', citationIndices);
            
            // Guardar el mapeo en una variable global para usarlo después
            window.citationIndices = citationIndices;
          } else if (data.retrieval && data.retrieval.retrieved_data) {
            console.log('✓ También encontrado en data.retrieval.retrieved_data');
            retrievalData = data.retrieval.retrieved_data;
            updateCitationMap(data.retrieval.retrieved_data);
          } else if (data.context && data.context.retrieved_data) {
            console.log('✓ También encontrado en data.context.retrieved_data');
            retrievalData = data.context.retrieved_data;
            updateCitationMap(data.context.retrieved_data);
          }

          // Convertir [C1] y 【C1】 a enlaces
          const processedMessage = processCitations(assistantMessage);
          console.log('Mapa final de citaciones:', citationMap);

          // Agregar a historial
          conversationHistory.push({
            role: 'assistant',
            content: assistantMessage
          });

          // Formatear y mostrar mensaje
          const formattedHTML = formatBotResponse(processedMessage);
          addMessage(formattedHTML, 'bot', true);
        } else {
          throw new Error('Respuesta inesperada del servidor');
        }
      } catch (error) {
        removeLoadingIndicator(loadingId);
        console.error('Error:', error);
        addMessage(`❌ Error: ${error.message}`, 'error');
      } finally {
        // Habilitar input
        messageInput.disabled = false;
        sendButton.disabled = false;
        messageInput.focus();
      }
    }

    function updateCitationMap(retrievedData) {
      // Actualizar mapeo de citaciones desde los datos recuperados
      retrievedData.forEach((item, index) => {
        const citationKey = `C${index + 1}`;
        if (item.filename) {
          citationMap[citationKey] = item.filename;
          console.log(`Mapeado ${citationKey} → ${item.filename}`);
        }
      });
    }

    function processCitations(text) {
      // Reemplazar TODOS los formatos: [C1], 【C1】, §C1 con enlaces
      const citationPattern = /[\[\【]?§?C(\d+)[\]\】]?/g;
      const citationMatches = text.match(citationPattern) || [];
      
      // Filtrar duplicados (puede haber matches vacías)
      const uniqueCitations = [...new Set(citationMatches)].filter(c => c.length > 0);
      console.log(`Procesando ${uniqueCitations.length} citaciones únicas: ${uniqueCitations.join(', ')}`);
      
      return text.replace(citationPattern, (match, num) => {
        if (!match || !num) return match;
        
        const citationNum = parseInt(num);
        const citationKey = `C${num}`;

        console.log(`  ${match} → citation num = ${citationNum}`);

        // Crear link sin href, con data-citation-num para poder acceder al extracto
        return `<a class="citation-link" data-citation-num="${citationNum}" onclick="showCitationModal('${citationKey}')">${match}</a>`;
      });
    }

    function formatBotResponse(html) {
      // Parsear la respuesta del agente y formatearla correctamente
      let formatted = html;

      // 1. Encapsular disclaimer
      formatted = formatted.replace(
        /\*\*No soy un abogado real, soy un asistente virtual de Barbara & Abogados\.\*\*/g,
        '<div class="disclaimer"><strong>No soy un abogado real, soy un asistente virtual de Barbara &amp; Abogados.</strong></div>'
      );

      // 2. Dividir por párrafos
      const parts = formatted.split(/\n\n+/);
      
      let result = '';
      let mainContent = '';
      let recommendation = '';
      let categoryText = '';
      let confidenceText = '';

      // Procesar cada parte
      for (let i = 0; i < parts.length; i++) {
        const part = parts[i].trim();
        
        if (!part) continue;

        // Si contiene "Te recomiendo"
        if (part.includes('Te recomiendo')) {
          recommendation = part;
        }
        // Si contiene "Categoría"
        else if (part.includes('**Categoría:**')) {
          // Extraer categoría: **Categoría:** texto
          const catMatch = part.match(/\*\*Categoría:\*\*\s*(.+?)(?=\n|$)/);
          if (catMatch) {
            categoryText = catMatch[1].trim();
          }
        }
        // Si contiene "Confianza"
        else if (part.includes('**Confianza')) {
          // Extraer confianza: **Confianza(respuesta):** 92% texto
          const confMatch = part.match(/\*\*Confianza[^:]*:\*\*\s*(.+?)(?=\n|$)/);
          if (confMatch) {
            confidenceText = confMatch[1].trim();
          }
        }
        // Si contiene el disclaimer
        else if (part.includes('disclaimer')) {
          result += part;
        }
        // Resto es contenido principal
        else {
          mainContent += part + '\n\n';
        }
      }

      // Construir el HTML final
      let finalHTML = result;
      
      // Agregar contenido principal
      if (mainContent.trim()) {
        finalHTML += `<div class="content">${mainContent.trim()}</div>`;
      }

      // Agregar recomendación
      if (recommendation) {
        finalHTML += `<div class="recommendation">${recommendation}</div>`;
      }

      // Agregar metadata con formato específico
      let metadataHTML = '<div class="metadata">';
      if (categoryText) {
        metadataHTML += `<div><strong>Categoría:</strong> ${categoryText}</div>`;
      }
      if (confidenceText) {
        metadataHTML += `<div><strong>Confianza(respuesta):</strong> ${confidenceText}</div>`;
      }
      metadataHTML += '</div>';
      
      if (categoryText || confidenceText) {
        finalHTML += metadataHTML;
      }

      return finalHTML;
    }

    function showCitationModal(citationKey) {
      // Obtener el índice de la citación desde el mapeo
      console.log(`Buscando citación: ${citationKey}`);
      console.log(`Retrieval data disponible:`, retrievalData);
      console.log(`Citation indices:`, window.citationIndices);
      
      let citationData = null;
      const modal = document.getElementById('citationModal');
      const modalBody = document.getElementById('citationModalBody');
      const modalMeta = document.getElementById('citationModalMeta');

      // Si hay retrieval data y mapeo de índices, usar el mapeo correcto
      if (retrievalData && retrievalData.length > 0 && window.citationIndices && window.citationIndices[citationKey] !== undefined) {
        const citationIndex = window.citationIndices[citationKey];
        
        if (citationIndex >= 0 && citationIndex < retrievalData.length) {
          citationData = retrievalData[citationIndex];
          console.log(`✓ Citación ${citationKey} encontrada en índice ${citationIndex}:`, citationData);
        }
      }

      // Si no encontró datos, mostrar error
      if (!citationData) {
        console.error(`No hay datos para la citación ${citationKey}`);
        alert(`No hay datos disponibles para la citación ${citationKey}`);
        return;
      }

      console.log(`Mostrando citación ${citationKey}:`, citationData);

      // Extraer nombre del documento del filename
      let documentName = 'Documento';
      if (citationData.filename) {
        // Extraer el nombre del archivo de la URL
        const parts = citationData.filename.split('/');
        documentName = parts[parts.length - 1] || 'Documento';
        // Decodificar URL encoded characters
        documentName = decodeURIComponent(documentName);
      }

      // Actualizar título del modal con el nombre del documento
      document.getElementById('citationModalTitle').textContent = documentName;

      // Mostrar contenido del extracto
      if (citationData.page_content) {
        modalBody.textContent = citationData.page_content;
      } else {
        modalBody.textContent = 'No hay contenido disponible';
      }

      // Mostrar metadata
      let metaHTML = '';
      if (citationData.metadata && citationData.metadata.page_number) {
        metaHTML += `<p><strong>Página:</strong> ${citationData.metadata.page_number}</p>`;
      }
      if (citationData.filename) {
        metaHTML += `<p><strong>Fuente:</strong> <a href="${citationData.filename}" target="_blank">Ver documento completo</a></p>`;
      }
      
      modalMeta.innerHTML = metaHTML;

      // Mostrar modal
      modal.classList.add('active');
    }

    function closeCitationModal() {
      const modal = document.getElementById('citationModal');
      modal.classList.remove('active');
    }

    // Cerrar modal al hacer click fuera
    document.addEventListener('DOMContentLoaded', function() {
      const modal = document.getElementById('citationModal');
      if (modal) {
        modal.addEventListener('click', function(e) {
          if (e.target === modal) {
            closeCitationModal();
          }
        });
      }
    });

    function addMessage(content, type, isHtml = false) {
      const messageGroup = document.createElement('div');
      messageGroup.className = `message-group ${type}`;

      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;

      if (isHtml) {
        messageDiv.innerHTML = content;
      } else {
        messageDiv.textContent = content;
      }

      messageGroup.appendChild(messageDiv);
      messagesContainer.appendChild(messageGroup);

      // Scroll al final
      scrollToBottom();
    }

    function addLoadingIndicator() {
      const id = `loading-${Date.now()}`;

      const messageGroup = document.createElement('div');
      messageGroup.className = 'message-group bot';
      messageGroup.id = id;

      const messageDiv = document.createElement('div');
      messageDiv.className = 'message bot';
      messageDiv.innerHTML = `
        <div class="message-loading">
          <span></span>
          <span></span>
          <span></span>
        </div>
      `;

      messageGroup.appendChild(messageDiv);
      messagesContainer.appendChild(messageGroup);

      scrollToBottom();
      return id;
    }

    function removeLoadingIndicator(id) {
      const element = document.getElementById(id);
      if (element) {
        element.remove();
      }
    }

    function scrollToBottom() {
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Mensaje de bienvenida
    window.addEventListener('load', () => {
      addMessage(
        '¡Hola! Soy tu Abogado Virtual. Estoy especializado en legislación española. ' +
        'Puedo ayudarte con preguntas sobre leyes, procedimientos administrativos, derechos y obligaciones. ' +
        '\n\n¿En qué puedo ayudarte?',
        'bot'
      );
    });
  </script>
</body>
</html>
