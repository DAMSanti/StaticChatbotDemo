<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chatbot - Static Demo</title>
  <style>
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:0;background:#f7fafc;color:#0f172a}
    .container{max-width:720px;margin:48px auto;padding:24px;background:#fff;border-radius:8px;box-shadow:0 6px 18px rgba(2,6,23,0.06)}
    .messages{height:400px;overflow:auto;border:1px solid #e6eef6;padding:12px;border-radius:6px;background:#f8fafc}
    .msg{margin:8px 0;padding:8px 12px;border-radius:16px;display:inline-block;max-width:80%}
    .msg.user{background:#0369a1;color:#fff;margin-left:auto}
    .msg.bot{background:#eef2ff;color:#0f172a}
    .input-row{display:flex;gap:8px;margin-top:12px}
    input[type="text"]{flex:1;padding:10px;border:1px solid #cbd5e1;border-radius:8px}
    button{padding:10px 14px;border:none;background:#0284c7;color:#fff;border-radius:8px}
    footer{margin-top:12px;font-size:12px;color:#475569}
  </style>
</head>
<body>
  <div class="container">
    <h1>Chatbot - Integrado</h1>
    <!-- Contenedor donde se renderizarÃ¡ el iframe del chatbot -->
    <div id="chat-container" style="width:100%;height:640px;border:1px solid #e6eef6;border-radius:6px;overflow:hidden;margin-top:16px"></div>

  </div>
  <!-- Chatbot widget (AbogadoVirtual Chatbot) -->
  <script async
    src="https://qyu5z3uycrlt22lufgs5ac6v.agents.do-ai.run/static/chatbot/widget.js"
    data-agent-id="a141afdb-c01e-11f0-b074-4e013e2ddde4"
    data-chatbot-id="IurFFh0JbzeH7PLauKvv7WKGaCJb5F6L"
    data-name="AbogadoVirtual Chatbot"
    data-primary-color="#031B4E"
    data-secondary-color="#E5E8ED"
    data-button-background-color="#0061EB"
    data-starting-message="Hello! How can I help you today?"
    data-logo="/static/chatbot/icons/default-agent.svg"
    data-render-target-id="chat-container">
  </script>

  <!-- Script: Interceptar y enriquecer citations con URLs -->
  <script>
    (function() {
      'use strict';

      // Mapeo de URLs del Ãºltimo retrieval para enriquecer citations
      let lastRetrievalData = [];
      let citationCounter = 0;

      // Interceptar fetch para capturar respuestas del agente
      const originalFetch = window.fetch;
      window.fetch = async function(...args) {
        const response = await originalFetch.apply(this, args);

        // Capturar llamadas al endpoint del agente
        if (args[0] && args[0].includes('chat/completions')) {
          try {
            const clone = response.clone();
            const data = await clone.json();

            // Guardar datos de retrieval para enriquecer citations
            if (data.retrieval && data.retrieval.retrieved_data) {
              lastRetrievalData = data.retrieval.retrieved_data;
              console.log('[Citations Enricher] Datos de retrieval capturados:', lastRetrievalData.length, 'items');

              // Enriquecer citations con URLs
              if (data.citations && data.citations.length > 0) {
                enrich_citations(data.citations, lastRetrievalData);
                console.log('[Citations Enricher] Citations enriquecidas con URLs');
                
                // Inyectar citations en el DOM despuÃ©s de un pequeÃ±o delay
                setTimeout(() => inject_citations_to_dom(data.citations), 500);
              }
            }
          } catch (err) {
            console.log('[Citations Enricher] Error procesando respuesta:', err.message);
          }
        }

        return response;
      };

      // FunciÃ³n para enriquecer citations con URLs del retrieval
      function enrich_citations(citations, retrievedData) {
        if (!citations || !retrievedData) return;

        // Construir mapa de URLs
        const urlMap = {};
        retrievedData.forEach((item, idx) => {
          if (item.filename) {
            urlMap[item.filename.toLowerCase()] = item.url || item.metadata?.url || '';
          }
          if (item.id) {
            urlMap[item.id] = item.url || item.metadata?.url || '';
          }
        });

        // Enriquecer cada citation
        citations.forEach((citation) => {
          if (!citation.metadata) {
            citation.metadata = {};
          }

          // Buscar URL por filename o id
          if (citation.metadata.filename) {
            const url = urlMap[citation.metadata.filename.toLowerCase()];
            if (url) {
              citation.metadata.url = url;
            }
          } else if (citation.id) {
            const url = urlMap[citation.id];
            if (url) {
              citation.metadata.url = url;
            }
          }

          // Si aÃºn no tiene URL, intentar con el texto
          if (!citation.metadata.url && retrievedData.length > 0) {
            const firstUrl = retrievedData[0].url || retrievedData[0].metadata?.url;
            if (firstUrl) {
              citation.metadata.url = firstUrl;
            }
          }
        });
      }

      // FunciÃ³n para inyectar citations en el DOM visible
      function inject_citations_to_dom(citations) {
        if (!citations || citations.length === 0) return;

        // Buscar el contenedor del widget
        const chatContainer = document.querySelector('[data-render-target-id="chat-container"]') || 
                            document.getElementById('chat-container');
        
        if (!chatContainer) {
          console.log('[Citations Enricher] Contenedor no encontrado');
          return;
        }

        // Buscar el Ãºltimo mensaje de bot en el widget
        // El widget usa iframes, asÃ­ que necesitamos buscar en el DOM
        const messages = chatContainer.querySelectorAll('[class*="message"], [class*="bot"], [class*="response"]');
        
        if (messages.length === 0) {
          // Alternativa: crear un panel de citations flotante
          create_citations_panel(citations);
          return;
        }

        // Agregar citations al final del Ãºltimo mensaje
        const lastMessage = messages[messages.length - 1];
        if (lastMessage) {
          const citationsHtml = create_citations_html(citations);
          lastMessage.innerHTML += citationsHtml;
          console.log('[Citations Enricher] Citations inyectadas en el DOM');
        }
      }

      // Crear un panel flotante de citations si no se puede inyectar en el widget
      function create_citations_panel(citations) {
        // Buscar panel existente
        let panel = document.getElementById('citations-panel');
        
        if (!panel) {
          panel = document.createElement('div');
          panel.id = 'citations-panel';
          panel.className = 'citations-panel';
          document.body.appendChild(panel);
        }

        // Limpiar panel anterior
        panel.innerHTML = '';

        // Agregar tÃ­tulo
        const title = document.createElement('div');
        title.className = 'citations-panel-title';
        title.textContent = 'ðŸ“š Fuentes de InformaciÃ³n';
        panel.appendChild(title);

        // Agregar citations
        citations.forEach((citation, idx) => {
          const citationEl = document.createElement('div');
          citationEl.className = 'citation-item';
          
          let html = `<div class="citation-number">C${idx + 1}</div>`;
          html += `<div class="citation-content">`;
          html += `<p class="citation-text">${citation.text}</p>`;
          
          if (citation.metadata?.url) {
            html += `<a href="${citation.metadata.url}" target="_blank" class="citation-url">`;
            html += `ðŸ”— Ver fuente completa</a>`;
          }
          
          html += `</div>`;
          citationEl.innerHTML = html;
          panel.appendChild(citationEl);
        });

        // Mostrar panel
        panel.style.display = 'block';
      }

      // Generar HTML para las citations
      function create_citations_html(citations) {
        if (!citations || citations.length === 0) return '';

        let html = '<div class="citations-container">';
        html += '<div class="citations-title">ðŸ“š Fuentes de InformaciÃ³n:</div>';
        
        citations.forEach((citation, idx) => {
          html += `<div class="citation-item">`;
          html += `<span class="citation-badge">C${idx + 1}</span>`;
          html += `<div class="citation-content">`;
          html += `<p>${citation.text}</p>`;
          
          if (citation.metadata?.url) {
            html += `<a href="${citation.metadata.url}" target="_blank" class="citation-link">`;
            html += `ðŸ”— Ver fuente</a>`;
          }
          
          html += `</div></div>`;
        });
        
        html += '</div>';
        return html;
      }

      // Inyectar estilos para las citations
      const style = document.createElement('style');
      style.textContent = `
        /* Panel flotante de citations */
        .citations-panel {
          position: fixed;
          bottom: 20px;
          right: 20px;
          width: 350px;
          max-height: 400px;
          background: linear-gradient(135deg, #f0f4ff 0%, #ffffff 100%);
          border: 2px solid #0284c7;
          border-radius: 12px;
          box-shadow: 0 10px 30px rgba(2, 132, 199, 0.2);
          overflow-y: auto;
          z-index: 10000;
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .citations-panel-title {
          padding: 16px;
          font-size: 16px;
          font-weight: 700;
          color: #0284c7;
          border-bottom: 2px solid #e0eaff;
          background: #f8fbfe;
          position: sticky;
          top: 0;
        }

        .citation-item {
          display: flex;
          gap: 12px;
          padding: 12px 16px;
          border-bottom: 1px solid #e0eaff;
          align-items: flex-start;
        }

        .citation-item:last-child {
          border-bottom: none;
        }

        .citation-item:hover {
          background: #f8fbfe;
        }

        .citation-number {
          min-width: 32px;
          height: 32px;
          background: #0284c7;
          color: white;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: 700;
          font-size: 12px;
          flex-shrink: 0;
        }

        .citation-content {
          flex: 1;
          min-width: 0;
        }

        .citation-text {
          margin: 0 0 8px 0;
          font-size: 13px;
          color: #1e293b;
          line-height: 1.4;
        }

        .citation-url {
          display: inline-block;
          color: #0284c7;
          text-decoration: none;
          font-size: 12px;
          font-weight: 600;
          padding: 4px 8px;
          background: #e0eaff;
          border-radius: 4px;
          transition: all 0.2s ease;
        }

        .citation-url:hover {
          background: #0284c7;
          color: white;
        }

        /* Citations dentro del widget */
        .citations-container {
          margin: 12px 0;
          padding: 12px;
          background: #f8fbfe;
          border-left: 4px solid #0284c7;
          border-radius: 6px;
        }

        .citations-title {
          font-size: 13px;
          font-weight: 700;
          color: #0284c7;
          margin-bottom: 8px;
        }

        .citation-badge {
          display: inline-block;
          min-width: 24px;
          height: 24px;
          background: #0284c7;
          color: white;
          border-radius: 50%;
          text-align: center;
          line-height: 24px;
          font-weight: 700;
          font-size: 11px;
          margin-right: 8px;
        }

        .citation-link {
          color: #0284c7;
          text-decoration: none;
          font-weight: 600;
          border-bottom: 2px solid #0284c7;
          transition: all 0.2s ease;
        }

        .citation-link:hover {
          color: #0369a1;
          border-bottom-color: #0369a1;
        }

        @media (max-width: 480px) {
          .citations-panel {
            width: calc(100% - 20px);
            right: 10px;
            left: 10px;
          }
        }
      `;
      document.head.appendChild(style);

      console.log('[Citations Enricher] Inicializado - Mostrando citations en la web');
    })();
  </script>
</body>
</html>
